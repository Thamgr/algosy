<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ê–ª–≥–æ—Å—ã ‚Äî —Ä–µ–π—Ç–∏–Ω–≥–∏</title>
  <link rel="icon" href="/algosy/static/logo.png" type="image/png" media="(prefers-color-scheme: light)">
  <link rel="icon" href="/algosy/static/logo_neg.png" type="image/png" media="(prefers-color-scheme: dark)">
  <style>
    :root{
      --bg:#0c0f14;--surface:#121621;--muted:#1a1f2b;--text:#e6e6ea;--subtle:#aab1c3;--accent:#6ae3ff;--accent-2:#9bff8a;--radius:16px;--shadow:0 8px 28px rgba(0,0,0,.35);--maxw:1100px;
    }
    body{margin:0;font-family:system-ui, sans-serif;background:var(--bg);color:var(--text);} 
    a{color:var(--accent);text-decoration:none}
    .container{max-width:var(--maxw);margin:0 auto;padding:24px;}
    header{position:sticky;top:0;background:#0c0f14d9;padding:14px 24px;}
    .nav{display:flex;align-items:center;gap:16px;max-width:var(--maxw);margin:0 auto;}
    .logo{display:flex;align-items:center;gap:10px;font-weight:700;}
    .logo-badge{display:grid;place-items:center;width:36px;height:36px;border-radius:10px;background:#172033;}
    .spacer{flex:1}
    .btn{padding:8px 12px;border-radius:10px;background:var(--muted);}
    h1{margin:0 0 16px;font-size:20px;color:var(--subtle);font-weight:600}

    .panel{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);}
    .section-title{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.06);color:var(--subtle);font-weight:600;}
    .body{padding:14px 18px}

    table{width:100%;border-collapse:collapse;}
    th,td{padding:10px 12px;text-align:left;}
    th{color:var(--subtle);font-weight:600;font-size:14px;border-bottom:1px solid rgba(255,255,255,.1);}
    td{border-bottom:1px solid rgba(255,255,255,.05);}
    td.score{font-variant-numeric:tabular-nums;}

    th:nth-child(1), td:nth-child(1) { width: 40px; }   /* # */
    th:nth-child(2), td:nth-child(2) { width: auto; }   /* –ò–º—è */
    th:nth-child(3), td:nth-child(3) { width: 80px; }   /* –¢–µ–∫—É—â–∏–π */
    th:nth-child(4), td:nth-child(4) { width: 200px; }  /* –ò—Å—Ç–æ—Ä–∏—è */

    .spark { width:200px; height:40px; }

    footer{color:var(--subtle);font-size:14px;padding:24px 0;text-align:center}
  </style>
</head>
<body>
  <header>
    <nav class="nav">
      <div class="logo">
        <div class="logo-badge"><span>üèÜ</span></div>
        <span>–ê–ª–≥–æ—Å—ã</span>
      </div>
      <div class="spacer"></div>
      <a class="btn" href="/algosy/">üè† –ì–ª–∞–≤–Ω–∞—è</a>
      <a class="btn" href="/algosy/topics/">üìö –ó–∞–Ω—è—Ç–∏—è</a>
      <a class="btn" href="/algosy/ratings/">üèÜ –†–µ–π—Ç–∏–Ω–≥–∏</a>
    </nav>
  </header>

  <main class="container">
    <h1>–†–µ–π—Ç–∏–Ω–≥–∏ –ø–æ –∫–æ–Ω—Ç–µ—Å—Ç–∞–º</h1>
    <section class="panel">
      <div class="body">
        <table id="ratings-table">
          <thead>
            <tr><th>#</th><th>–£—á–∞—Å—Ç–Ω–∏–∫</th><th>–≠–ª–æ</th><th>–ò—Å—Ç–æ—Ä–∏—è</th></tr>
          </thead>
          <tbody>
            <tr><td colspan="4">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <footer>
      ¬© 2025 –ê–ª–≥–æ—Å—ã ‚Äî <a href="https://github.com/Thamgr/algosy" target="_blank">GitHub</a>
    </footer>
  </main>

  <script>
  (function(){
    // Original API URL
    const API_URL = "http://89.169.183.158:8000/ratings?type=list";
    
    // CORS proxy options (try different ones if needed)
    // Note: When running locally with file:// protocol, CORS restrictions will apply
    // In production, this page should be served from a proper web server
    const CORS_PROXY = "https://api.allorigins.win/raw?url=";
    
    const TBODY = document.querySelector('#ratings-table tbody');

    const fmt = n => Number.isFinite(n) ? (Math.abs(n - Math.round(n)) < 1e-6 ? String(Math.round(n)) : n.toFixed(1)) : '‚Äî';

    function buildEmptySparkline(w=100, h=48){
      return `<svg class="spark" viewBox="0 0 ${w} ${h}"></svg>`;
    }

    // No fallback data - we'll only use the API

    async function fetchRatings() {
      TBODY.innerHTML = '<tr><td colspan="4">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr>';
      
      // Try multiple methods to get the data
      try {
        // Method 1: Try direct fetch (works when served from proper server)
        try {
          const response = await fetch(API_URL);
          if (response.ok) {
            const data = await response.json();
            renderRatings(data);
            return;
          }
        } catch (directError) {
          console.log('[ratings] Direct fetch failed, trying proxy', directError);
        }
        
        // Method 2: Try CORS proxy
        try {
          const proxyUrl = CORS_PROXY + encodeURIComponent(API_URL);
          const proxyResponse = await fetch(proxyUrl);
          if (proxyResponse.ok) {
            const data = await proxyResponse.json();
            renderRatings(data);
            return;
          }
        } catch (proxyError) {
          console.log('[ratings] Proxy fetch failed', proxyError);
        }
        
        // If all methods fail, show error
        console.log('[ratings] All fetch methods failed');
        TBODY.innerHTML = '<tr><td colspan="4">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å</td></tr>';
        
      } catch (error) {
        console.error('[ratings] All fetch methods failed', error);
        TBODY.innerHTML = '<tr><td colspan="4">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å</td></tr>';
      }
    }

    function renderRatings(data) {
      try {
        if (!data || Object.keys(data).length === 0) {
          TBODY.innerHTML = '<tr><td colspan="4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
          return;
        }

        // Convert data to array format
        const recs = Object.entries(data).map(([username, info]) => {
          const name = info[0] || username;
          const rating = info[1] || 0;
          return { username, name, current: rating };
        });

        // Sort by rating (descending)
        recs.sort((a, b) => b.current - a.current);

        // Render table
        TBODY.innerHTML = recs.map((e, idx) => `
          <tr>
            <td>${idx+1}</td>
            <td>${e.name}</td>
            <td class="score">${fmt(e.current)}</td>
            <td>${buildEmptySparkline()}</td>
          </tr>`).join("") || '<tr><td colspan="4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
      } catch (e) {
        console.error('[ratings] render error', e);
        TBODY.innerHTML = '<tr><td colspan="4">–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö</td></tr>';
      }
    }

    document.addEventListener('DOMContentLoaded', fetchRatings);
  })();
  </script>
</body>
</html>